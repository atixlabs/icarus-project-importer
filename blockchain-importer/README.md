# `cardano-sl-blockchain-importer`

Package based on the `cardano-sl-explorer` (in how it's hooked to the Cardano node), which keeps a postgres db up-to-date with it's rocks db, saving in it:
- The current UTxO.
- The best block number.
- The tx history (including successful, failed and pending txs).

## Installation

### Requirements

- Installation of `nix` is needed:

```bash
curl https://nixos.org/nix/install | sh
source ~/.nix-profile/etc/profile.d/nix.sh
```

- Installation of [Docker](https://hub.docker.com/_/postgres/) is needed.

## Generate documentation

Generated documentation for BlockchainImporter Web API can be obtained (as `blockchain-importer-web-api-swagger.json`) by running:
```bash
stack exec cardano-importer-swagger
```

## Run it

1) Install PostgresSQL and [run the scripts to create the necessary tables] (https://github.com/input-output-hk/project-icarus-importer/blob/icarus-master/scripts/generate/blockImporterTables-beta.sql)
2) `sudo apt-get install liblzma-dev libpq-dev`
3) `curl https://nixos.org/nix/install > install-nix.sh && . install-nix.sh`
4) `nix-build . -A connectScripts.mainnetBlockchainImporter -o importer-bin`
5) `./importer-bin - --runtime-args '--postgres-name importer --postgres-password mysecretpassword --no-tls` # Complete with the data you defined in step (1)

When starting-up, a consistency check is run (if the flag `--no-consistency-check` is not used). **If this fails please check that the proper DBs were configured (and they are from the same network).** This could fail with a block number difference, for two reasons:
- The DBs weren't obtained from the same importer execution. For example, this happens if the importer is run with the DB of an external Cardano node.
- The importer was stopped while it was rollbacking `2k` blocks upon a new epoch.

In both cases, using the `--recovery-mode` recovers from the DBs differences.


## Recovery mode

In case of a potential crash of the importer, or the server running it, the importer Rocks db could reach a corrupted state (with `DBMalformed error` for example). To address this problem:
- Have a back-up Cardano node syncing (in the same chain)
- When the crash happens, stop the Cardano node and start-up the importer on recovery mode with the same Postgres db configured, but using the Rocks db of the Cardano node (configured with `--db-path`).
**Note**: Recovery mode can be enabled with the flag `--recovery-mode`.


# `cardano-sl-importer-db-consistency`

Checks the consistency of the postgres db generated by the `cardano-sl-blockchain-importer` internally (with it's rocks db) and externally (with the db of a Cardano node).

The following checks were carried out (and should be re-done periodically):
- Check the internal consistency of the staging and mainnet dbs (using `blockchain-importer/scripts/launch/internal-consistency.sh`).
- Check the internal consistency of the db upon restart (using `blockchain-importer/scripts/launch/restart-consistency.sh`).
- Check the consistency of an up-to-date db with the one of an up-to-date Cardano node (using `blockchain-importer/scripts/launch/external-consistency-from-blk.sh`).

The results and configurations used for the scripts can be seen in `blockchain-importer/scripts/launch/staging-test-results.txt` and `blockchain-importer/scripts/launch/mainnet-test-results.txt`.
